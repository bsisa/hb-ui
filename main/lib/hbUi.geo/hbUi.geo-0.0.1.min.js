/*! hbUi.geo 2016-09-07 Copyright 2016 Patrick Refondini. Licensed under the Apache License, Version 2.0 */
!function(){angular.module("hbUi.geo",["restangular"]),angular.module("hbUi.geo").config(["$logProvider",function(a){a.debugEnabled(clientDebugEnabled)}]),angular.module("hbUi.geo").config(["$locationProvider",function(a){a.html5Mode(!0)}]),angular.module("hbUi.geo").config(["$compileProvider",function(a){a.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|file|chrome-extension):/)}])}(),function(){angular.module("hbUi.geo").factory("hbGeoLeafletService",["$log","hbGeoService",function(a,b){var c=function(a,c){var d=b.getElfinBasePoint(a);if(!d)return null;var e=b.getLongitudeLatitudeCoordinates(d.X,d.Y),f=L.circleMarker(L.latLng(e.lat,e.lng),c);return f},d=function(a,c){var d=b.getElfinBasePoint(a);if(!d)return null;var e=b.getLongitudeLatitudeCoordinates(d.X,d.Y),f=L.marker(L.latLng(e.lat,e.lng),c);return f},e=function(a){var c=b.getElfinZone1Points(a),d=_.map(c,function(a){var c=b.getLongitudeLatitudeCoordinates(a.X,a.Y);return L.latLng(c.lat,c.lng)});return d},f=function(a,b){var c=e(a);if(c&&c.length>0){var d=L.polygon(c,b);return d}return null},g=function(a,b,e){var g=null;switch(b.toLowerCase()){case"point":g=c(a,e);break;case"marker":g=d(a,e);break;case"polygon":g=f(a,e)}return null!==g&&(g.bindPopup(p(a)),angular.extend(g,{representation:b.toLowerCase()})),g},h=function(){var a=L.Icon.extend({options:{iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41],zIndexOffset:1e3}}),b=new a({iconUrl:"/assets/lib/leaflet/custom/markers/marker-icon-purple.png"}),c={icon:b};return c},i=function(){var a=L.Icon.extend({options:{iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41],zIndexOffset:999}}),b=new a({iconUrl:"/assets/lib/leaflet/custom/markers/marker-icon.png"}),c={icon:b};return c},j=function(a,b){var c={},d=g(a,b,c);return d.getBounds()},k=function(a,b){angular.isDefined(b.getPopup)&&b.getPopup()&&b.getPopup().setContent(p(a))},l=function(a,b){if(angular.isDefined(b.setLatLngs)){var c=e(a);c&&c.length>0&&b.setLatLngs(c)}},m=function(a,c){if(angular.isDefined(c.setLatLng)){var d=b.getElfinBasePoint(a);if(d){var e=b.getLongitudeLatitudeCoordinates(d.X,d.Y);c.setLatLng(L.latLng(e.lat,e.lng))}}},n=function(){var a={iconStyles:{selectedMarker:h(),standardMarker:i()},center:{lat:0,lng:0,zoom:10},defaults:{drawControl:!0},layers:{baselayers:{standard:{name:"Standard",url:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",type:"xyz"},transport:{name:"Transport",url:"http://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png",type:"xyz"}},overlays:{}}};return a},o=function(){var a={draw:{toolbar:{actions:{title:"Annuler le dessin",text:"Annuler"},undo:{title:"Effacer le dernier point dessiné",text:"Effacer le dernier point"},buttons:{polyline:"Dessiner une polyligne",polygon:"Dessiner un polygone",marker:"Dessiner un point",rectangle:"Draw a rectangle",circle:"Draw a circle"}},handlers:{circle:{tooltip:{start:"Click and drag to draw circle."}},rectangle:{tooltip:{start:"Click and drag to draw rectangle."}},simpleshape:{tooltip:{end:"Release mouse to finish drawing."}},marker:{tooltip:{start:"Click sur le plan pour placer un point."}},polygon:{tooltip:{start:"Click pour commencer à dessiner la forme.",cont:"Click pour continuer de dessiner.",end:"Click sur le premier point pour fermer la forme."}},polyline:{error:"<strong>Erreur:</strong> les côtés ne peuvent pas se croiser!",tooltip:{start:"Click pour commencer à dessiner la ligne.",cont:"Click pour continuer de dessiner.",end:"Click sur le dernier point pour terminer."}}}},edit:{toolbar:{actions:{save:{title:"Save changes.",text:"Save"},cancel:{title:"Cancel editing, discards all changes.",text:"Cancel"}},buttons:{edit:"Edit layers.",editDisabled:"No layers to edit.",remove:"Delete layers.",removeDisabled:"No layers to delete."}},handlers:{edit:{tooltip:{text:"Drag handles, or marker to edit feature.",subtext:"Click cancel to undo changes."}},remove:{tooltip:{text:"Click on a feature to remove"}}}}};return a},p=function(a){var b="<b>"+a.IDENTIFIANT.NOM+" "+a.IDENTIFIANT.ALIAS+"</b><br>";return b+="No SAI <b>"+a.IDENTIFIANT.OBJECTIF+"</b> - "+a.CLASSE+"<br>",b+='<a href="/elfin/'+a.ID_G+"/"+a.CLASSE+"/"+a.Id+'">Détails</a>'};return{getDefaultLeafletScopeVars:n,getDrawLocalTranslation:o,getObjectBounds:j,getObjectLayer:g,getSelectedObjectMarkerStyle:h,getStandardObjectMarkerStyle:i,updateLayerCoords:m,updateLayerPopupContent:k,updatePolygonCoords:l}}])}(),function(){angular.module("hbUi.geo").factory("hbGeoService",["$log",function(a){var b=function(a){if(!a||!a.FORME)return null;var b=null;return angular.forEach(a.FORME.POINT,function(a){"base"===a.FONCTION.toLowerCase()&&(b=a)}),b},c=function(a,b){var c=parseInt(b);if(!isNaN(c)&&a){var d=_.find(a,function(a){return a.POS===c});return d}},d=function(a){if(!a.FORME)return null;var b=c(a.FORME.ZONE,"1");if(!b)return null;var d=[];return angular.forEach(b.LIGNE,function(b){var e=b.Id.split("#")[1],f=c(a.FORME.LIGNE,e);angular.forEach(f.PASSAGE,function(b){var e=b.Id.split("#")[1],f=c(a.FORME.POINT,e);d.push(f)})}),d},e=600072.37,f=600067,g=200147.07,h=200147.07,i=function(a,b){var c={X:parseFloat(a),Y:parseFloat(b)},d=(c.Y-h)/1e6,e=d*d,g=e*d,i=g*d,j=(c.X-f)/1e6,k=j*j,l=k*j,m=l*j,n=m*j,o=4.72973056+.7925714*d+.132812*e+.0255*g+.0048*i,p=-.04427-.0255*d-.0096*e,q=96e-5,r=0+3.23864877*d-.0025486*e-.013245*g+48e-6*i,s=-.27135379-.0450442*d-.007553*e-.00146*g,t=.002442+.00132*d,u=16.902866+r+s*k+t*m,v=2.67825+o*j+p*l+q*n,w=100*u/36,x=100*v/36;return{lat:w,lng:x}},j=function(a,b){if(!a||!b)return{x:0,y:0};var c={lat:parseFloat(a),lng:parseFloat(b)},d=36*c.lat/100-16.902866,f=d*d,h=f*d,i=36*c.lng/100-2.67825,j=i*i,k=j*i,l=e+211455.93*i-10938.51*i*d-.36*i*f-44.54*k,m=g+308807.95*d+3745.25*j+76.63*f-194.56*j*d+119.79*h;return{x:l,y:m}};return{getElfinBasePoint:b,getElfinZone1Points:d,getLongitudeLatitudeCoordinates:i,getSwissFederalCoordinates:j,getElByPos:c}}])}(),function(){angular.module("hbUi.geo").factory("hbGeoSwissCoordinatesService",["Restangular","$log",function(a,b){b.debug(">>> hbGeoSwissCoordinatesService factory start...");var c=void 0,d=function(){var d=a.withConfig(function(a){null==hbGeoApiUrl?b.error("hbGeoSwissCoordinatesService required hbGeoApiUrl information missing. This information is served dynamically by the HyperBird server, please make sure it is running."):(b.debug("hbGeoSwissCoordinatesService required hbGeoApiUrl: "+hbGeoApiUrl),a.setBaseUrl(hbGeoApiUrl))});c=d.all("")};return d(),{getLongitudeLatitudeCoordinates:function(a,d){var e="coordinates/gps/"+a+"/"+d+"/477.0";return b.debug("REMOTE: restGetQuery = "+e),c.one(e)},getLongitudeLatitudeCoordinatesList:function(){var a="coordinates/gps/";return b.debug("REMOTE: restPostQueryURL = "+a),c.all(a)},getSwissFederalCoordinates:function(a,d){var e="coordinates/swiss/"+a+"/"+d+"/527.0";return b.debug("REMOTE: restGetQuery = "+e),c.one(e)},getCoordinatesBoundsForRaster:function(){var a="coordinates/raster/bounds/";return b.debug("REMOTE: restPostQueryURL = "+a),c.all(a)}}}])}();